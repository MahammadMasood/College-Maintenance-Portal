{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reports | College Maintenance Portal</title>

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <style>
    :root{
      --accent:#003366;
      --muted:#6b7280;
      --card:#fff;
    }

    html,body{height:100%; margin:0; font-family: "Poppins", sans-serif; background:#f6f8fb; color:#0f172a;}
    .page { min-height:100vh; display:flex; flex-direction:column; }
    header, footer { flex: 0 0 auto; }
    main { flex: 1 0 auto; padding:24px; max-width:1100px; margin: 0 auto; width:100%; }

    /* navbar (kept minimal so it matches your app) */
    .navbar { background: var(--accent); }
    .navbar .nav-link { color: #cfe8ff; font-weight:600; }
    .navbar .nav-link.active, .navbar .nav-link:hover { background: rgba(255,255,255,0.08); color:#fff; border-radius:6px; }

    /* page header */
    .reports-header { text-align:center; margin-bottom:18px; }
    .reports-header h1{ margin:0; color:var(--accent); }
    .reports-header p{ color:var(--muted); margin:6px 0 0; }

    /* filters row */
    .filters-row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; margin-bottom:16px; }
    .filter-btn { min-width:120px; }
    #customPicker { display:flex; gap:8px; align-items:center; margin-left:8px; }

    /* table card */
    .card-table { background:var(--card); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(10,12,30,0.04); }
    .table-wrapper { min-height:360px; /* keeps visual size constant */ max-height:520px; overflow:auto; }
    table { width:100%; border-collapse:collapse; table-layout:fixed; }
    thead th { position:sticky; top:0; background:#0b2940; color:#fff; z-index:5; padding:10px; text-align:left; }
    tbody td { padding:12px; border-bottom:1px solid #eef4fb; vertical-align:middle; }
    tbody tr:hover { background:#f1f7ff; }

    /* header filter arrow + dropdown placed inside th */
    th.filter-col { position:relative; }
    .filter-icon { margin-left:8px; cursor:pointer; color:#dbeefe; font-size:14px; vertical-align:middle; }
    .col-dropdown {
      position:absolute;
      top:100%;
      left:0;
      margin-top:6px;
      background:#fff;
      border:1px solid #ddd;
      border-radius:8px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      min-width:150px;
      display:none;
      z-index:1200;
      padding:6px 0;
    }
    .col-dropdown.active{ display:block; }
    .col-dropdown button {
      display:block; width:100%; padding:8px 12px; border:0; background:transparent; text-align:left; color:var(--accent); font-weight:600; cursor:pointer;
    }
    .col-dropdown button:hover{ background:var(--accent); color:#fff; border-radius:6px; }

    /* status badges */
    .badge-status { padding:6px 10px; border-radius:10px; font-weight:600; color:#fff; display:inline-block; }
    .s-pending { background:#f59e0b; }
    .s-completed { background:#16a34a; }
    .s-inprogress { background:#0ea5e9; }

    /* footer */
    footer { background:var(--accent); color:#fff; text-align:center; padding:16px 12px; margin-top:24px; }

    /* responsive tweaks */
    @media (max-width:700px){
      thead th { font-size:13px; }
      .filter-btn { min-width:90px; font-size:13px; }
      #customPicker { width:100%; justify-content:space-between; margin-top:8px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- NAVBAR -->
    <header>
      <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
          <a class="navbar-brand fw-bold text-white" href="{% url 'admin_dashboard' %}">College Maintenance Portal</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navCollapse">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navCollapse">
            <ul class="navbar-nav ms-auto align-items-center">
              <li class="nav-item"><a class="nav-link" href="{% url 'admin_dashboard' %}">Dashboard</a></li>
              <li class="nav-item"><a class="nav-link" href="{% url 'principal_view_quotations' %}">View Quotations</a></li>
              <li class="nav-item"><a class="nav-link active" href="{% url 'reports' %}">Reports</a></li>
              <li class="nav-item ms-2">
                <form method="post" action="{% url 'logout' %}">{% csrf_token %}
                  <button class="btn btn-warning btn-sm fw-semibold">Logout</button>
                </form>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- MAIN -->
    <main>
      <section class="reports-header">
        <h1>Maintenance Reports</h1>
        <p>Filter reports by time range, department and status.</p>
      </section>

      <!-- Time filters + custom -->
      <div class="filters-row mb-2">
        <div class="btn-group" role="group" aria-label="quick-filters">
          <button class="btn btn-outline-primary filter-btn" data-filter="week">This Week</button>
          <button class="btn btn-outline-primary filter-btn" data-filter="month">This Month</button>
          <button class="btn btn-outline-primary filter-btn" data-filter="year">This Year</button>
          <button class="btn btn-outline-secondary filter-btn" data-filter="custom">Custom</button>
        </div>

        <div id="customPicker" style="display:none; align-items:center;">
          <label for="customDate" class="me-2 text-muted">Pick date:</label>
          <input id="customDate" type="date" class="form-control form-control-sm" style="width:180px;">
          <button id="applyCustom" class="btn btn-sm btn-success ms-2">Apply</button>
        </div>

        <div id="clearFiltersWrapper" style="margin-left:12px;">
          <button id="clearFiltersBtn" class="btn btn-outline-danger btn-sm">Reset Filters</button>
        </div>
      </div>

      <!-- Table card -->
      <div class="card card-table">
        <div class="table-wrapper">
          <table id="reportsTable">
            <thead>
              <tr>
                <th style="width:70px">ID</th>

                <!-- Department header with inline dropdown (positioned via CSS inside th) -->
                <th class="filter-col" style="width:160px;">
                  <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span>Department</span>
                    <i class="bi bi-chevron-down filter-icon" id="deptIcon" title="Filter Department"></i>
                  </div>

                  <div class="col-dropdown" id="deptDropdown" aria-hidden="true">
                    <button data-filter="">All Departments</button>
                    <!-- dynamic list if you have departments context -->
                    <button data-filter="CS">CS</button>
                    <button data-filter="EE">EE</button>
                    <button data-filter="ME">ME</button>
                    <button data-filter="CE">CE</button>
                    <button data-filter="General">General</button>
                  </div>
                </th>

                <th style="text-align:left;">Issue</th>
                <th style="width:140px;">Date</th>

                <!-- Status header -->
                <th class="filter-col" style="width:140px;">
                  <div style="display:flex;align-items:center;justify-content:space-between;">
                    <span>Status</span>
                    <i class="bi bi-chevron-down filter-icon" id="statusIcon" title="Filter Status"></i>
                  </div>

                  <div class="col-dropdown" id="statusDropdown" aria-hidden="true">
                    <button data-filter="">All Status</button>
                    <button data-filter="Pending">Pending</button>
                    <button data-filter="Completed">Completed</button>
                    <button data-filter="In Progress">In Progress</button>
                  </div>
                </th>

                <th style="width:110px">Action</th>
              </tr>
            </thead>

            <tbody>
              <!-- If your backend supplies rows, they'll work automatically. Example rows below. -->
              <tr>
                <td>001</td>
                <td class="dept-cell">CS</td>
                <td class="issue-cell text-start">Projector not working</td>
                <td class="date-cell">2025-11-01</td>
                <td class="status-cell">Pending</td>
                <td><button class="btn btn-sm btn-primary">View</button></td>
              </tr>

              <tr>
                <td>002</td>
                <td class="dept-cell">EE</td>
                <td class="issue-cell text-start">Fuse blown</td>
                <td class="date-cell">2025-10-28</td>
                <td class="status-cell">Completed</td>
                <td><button class="btn btn-sm btn-primary">View</button></td>
              </tr>

              <tr>
                <td>003</td>
                <td class="dept-cell">ME</td>
                <td class="issue-cell text-start">AC maintenance</td>
                <td class="date-cell">2025-11-05</td>
                <td class="status-cell">In Progress</td>
                <td><button class="btn btn-sm btn-primary">View</button></td>
              </tr>

              <tr>
                <td>004</td>
                <td class="dept-cell">CE</td>
                <td class="issue-cell text-start">Broken chairs</td>
                <td class="date-cell">2025-11-04</td>
                <td class="status-cell">Pending</td>
                <td><button class="btn btn-sm btn-primary">View</button></td>
              </tr>

              <!-- add more rows from server as needed -->
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- FOOTER -->
    <footer>
      <div>Masood | Musthak | Rithwik | Akshay | Milan</div>
      <small>© 2025 College Maintenance Portal</small>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const deptIcon = document.getElementById('deptIcon');
      const statusIcon = document.getElementById('statusIcon');
      const deptDropdown = document.getElementById('deptDropdown');
      const statusDropdown = document.getElementById('statusDropdown');
      const rowsNodeList = document.querySelectorAll('#reportsTable tbody tr');
      const rows = Array.from(rowsNodeList);
      const filterBtns = document.querySelectorAll('.filter-btn');
      const customPicker = document.getElementById('customPicker');
      const customDateInput = document.getElementById('customDate');
      const applyCustom = document.getElementById('applyCustom');
      const clearFiltersBtn = document.getElementById('clearFiltersBtn');
      const resultsTitle = document.getElementById('resultsTitle');

      // track active filters
      let activeDept = '';
      let activeStatus = '';
      let activeDateRange = null; // {start:Date, end:Date, label:string}

      // Utility: show/hide dropdowns
      function closeAllDropdowns() {
        deptDropdown.classList.remove('active');
        statusDropdown.classList.remove('active');
      }
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.col-dropdown') && !e.target.classList.contains('filter-icon')) {
          closeAllDropdowns();
        }
      });

      // Toggle dropdowns (positioned inside th so no manual coordinate needed)
      deptIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = deptDropdown.classList.toggle('active');
        if (open) statusDropdown.classList.remove('active');
      });
      statusIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        const open = statusDropdown.classList.toggle('active');
        if (open) deptDropdown.classList.remove('active');
      });

      // Apply combined filters to rows
      function applyFilters() {
        rows.forEach(row => {
          const rowDept = (row.querySelector('.dept-cell')?.textContent || '').trim();
          const rowStatus = (row.querySelector('.status-cell')?.textContent || '').trim();
          const rowDateText = (row.querySelector('.date-cell')?.textContent || '').trim();

          // Date parsing: assume yyyy-mm-dd or dd mm yyyy — try to parse reliably
          let rowDate = null;
          // attempt ISO first
          const isoCandidate = rowDateText.indexOf('-') > -1 ? rowDateText : null;
          if (isoCandidate) {
            // try "YYYY-MM-DD" or "YYYY-MM-DDTHH:MM:SS"
            const parsed = new Date(rowDateText);
            if (!isNaN(parsed)) rowDate = parsed;
          } else {
            // fallback: parse dd MMM yyyy (e.g., "01 Nov 2025") if used
            const parsed2 = new Date(rowDateText);
            if (!isNaN(parsed2)) rowDate = parsed2;
          }

          let passDept = !activeDept || activeDept === '' || rowDept === activeDept;
          let passStatus = !activeStatus || activeStatus === '' || rowStatus === activeStatus;
          let passDate = true;
          if (activeDateRange && rowDate instanceof Date && !isNaN(rowDate)) {
            passDate = (rowDate >= activeDateRange.start && rowDate <= activeDateRange.end);
          }

          row.style.display = (passDept && passStatus && passDate) ? '' : 'none';
        });

        // update title with filter summary
        let parts = [];
        if (activeDateRange) parts.push(activeDateRange.label);
        if (activeDept) parts.push(`Dept: ${activeDept}`);
        if (activeStatus) parts.push(`Status: ${activeStatus}`);
        resultsTitle && (resultsTitle.textContent = parts.length ? `Showing — ${parts.join(' • ')}` : 'Showing: All recent reports');
      }

      // Department dropdown buttons
      deptDropdown.querySelectorAll('button[data-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
          activeDept = btn.dataset.filter || '';
          // highlight selection visually
          deptDropdown.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          deptDropdown.classList.remove('active');
          applyFilters();
        });
      });

      // Status dropdown buttons
      statusDropdown.querySelectorAll('button[data-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
          activeStatus = btn.dataset.filter || '';
          statusDropdown.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          statusDropdown.classList.remove('active');
          applyFilters();
        });
      });

      // Quick time filters
      function setDateRange(start, end, label) {
        activeDateRange = { start, end, label };
        applyFilters();
      }

      function clearDateRange() { activeDateRange = null; applyFilters(); }

      filterBtns.forEach(b => {
        b.addEventListener('click', () => {
          filterBtns.forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          const f = b.dataset.filter;
          if (f === 'custom') {
            customPicker.style.display = 'flex';
            return;
          } else {
            customPicker.style.display = 'none';
          }

          const now = new Date();
          if (f === 'week') {
            // compute Monday-Sunday week containing today
            const day = now.getDay(); // 0 Sun..6 Sat
            const mondayDiff = (day === 0 ? -6 : 1 - day); // move to Monday
            const monday = new Date(now); monday.setDate(now.getDate() + mondayDiff); monday.setHours(0,0,0,0);
            const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); sunday.setHours(23,59,59,999);
            setDateRange(monday, sunday, `This week (${formatDate(monday)} - ${formatDate(sunday)})`);
          } else if (f === 'month') {
            const start = new Date(now.getFullYear(), now.getMonth(), 1); start.setHours(0,0,0,0);
            const end = new Date(now.getFullYear(), now.getMonth()+1, 0); end.setHours(23,59,59,999);
            setDateRange(start, end, `This month (${start.toLocaleString(undefined,{month:'short',year:'numeric'})})`);
          } else if (f === 'year') {
            const start = new Date(now.getFullYear(), 0, 1); start.setHours(0,0,0,0);
            const end = new Date(now.getFullYear(), 11, 31); end.setHours(23,59,59,999);
            setDateRange(start, end, `This year (${now.getFullYear()})`);
          } else {
            clearDateRange();
          }
        });
      });

      // Apply custom date
      applyCustom.addEventListener('click', () => {
        const dv = customDateInput.value;
        if (!dv) { alert('Choose a date first'); return; }
        const d = new Date(dv);
        const start = new Date(d); start.setHours(0,0,0,0);
        const end = new Date(d); end.setHours(23,59,59,999);
        // visually mark custom button active
        filterBtns.forEach(x=>x.classList.remove('active'));
        document.querySelector('.filter-btn[data-filter="custom"]').classList.add('active');
        customPicker.style.display = 'flex';
        setDateRange(start, end, `Custom: ${formatDate(start)}`);
      });

      // Reset filters
      clearFiltersBtn.addEventListener('click', () => {
        activeDept = ''; activeStatus = ''; activeDateRange = null;
        // clear active marks
        deptDropdown.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        statusDropdown.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        filterBtns.forEach(x=>x.classList.remove('active'));
        customPicker.style.display = 'none';
        customDateInput.value = '';
        applyFilters();
      });

      // small helpers
      function formatDate(d) {
        return d.toLocaleDateString(undefined, {month:'short', day:'2-digit', year:'numeric'});
      }

      // initially show all
      applyFilters();

    }); // DOMContentLoaded
  </script>
</body>
</html>
